<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…äºº_show - TripSync</title>
    
    <!-- 1. æ¨£å¼åº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Babel (JSX ç·¨è­¯å™¨) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
        "firebase/storage": "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js",
        "lucide-react": "https://esm.sh/lucide-react@0.300.0"
      }
    }
    </script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-[#fdfbf7]">
    <div id="root"></div>

    <!-- ä¸»ç¨‹å¼é‚è¼¯ -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        
        // Firebase Imports
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
        import { 
            getFirestore, collection, addDoc, doc, updateDoc, 
            onSnapshot, serverTimestamp, getDoc, enableIndexedDbPersistence 
        } from 'firebase/firestore';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'firebase/storage';
        
        // Icons
        import { 
            Plus, Share2, Trash2, MapPin, ArrowLeft, Plane, Home, Car, FileText, X, 
            Users, DollarSign, Check, Luggage, Tent, PlaneTakeoff, PlaneLanding, Backpack, 
            Edit3, Calendar, Smile, Ghost, Gamepad2, Coffee, Music, Sun, AlertCircle, 
            Zap, Utensils, ChevronDown, ChevronUp, Grid, Activity, Droplet, ArrowUp, 
            ArrowDown, GripVertical, Settings, Copy, Globe, Map, CreditCard, Camera, 
            Loader, Paperclip, Navigation
        } from 'lucide-react';

        // âš ï¸âš ï¸âš ï¸ é—œéµè¨­å®šå€ âš ï¸âš ï¸âš ï¸
        // å¦‚æœæ‚¨ä¸‹è¼‰æ­¤æª”æ¡ˆï¼Œè«‹å°‡ä¸‹æ–¹çš„ "YOUR_..." æ›¿æ›ç‚ºæ‚¨ Firebase Console ä¸­çš„çœŸå¯¦è¨­å®š
        const userFirebaseConfig = {
            apiKey: "AIzaSyDwTot-z8M7mpMmB3hvtn8-3KkfUs-lndI",
  authDomain: "tripsync-myplan.firebaseapp.com",
  projectId: "tripsync-myplan",
  storageBucket: "tripsync-myplan.firebasestorage.app",
  messagingSenderId: "538565101058",
  appId: "1:538565101058:web:9f8c41bfd334124a07091b"
        };

        // è‡ªå‹•åˆ¤æ–·ï¼šè‹¥åœ¨é è¦½ç’°å¢ƒä½¿ç”¨å…§å»ºè®Šæ•¸ï¼Œè‹¥ä¸‹è¼‰å¾Œå‰‡ä½¿ç”¨ä¸Šæ–¹è¨­å®š
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        try {
            enableIndexedDbPersistence(db).catch((err) => {
                if (err.code === 'failed-precondition') console.log('å¤šå€‹åˆ†é é–‹å•Ÿï¼Œé›¢ç·šæ¨¡å¼åƒ…åœ¨ä¸€å€‹åˆ†é æœ‰æ•ˆ');
                else if (err.code === 'unimplemented') console.log('ç€è¦½å™¨ä¸æ”¯æ´é›¢ç·šæ¨¡å¼');
            });
        } catch (e) {}

        // --- Helpers ---
        const copyToClipboard = (text) => {
            if (!text) return false;
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                return successful;
            } catch (err) {
                document.body.removeChild(textArea);
                return false;
            }
        };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const MAX_WIDTH = 1024;
                        const MAX_HEIGHT = 1024;
                        if (width > height) {
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        } else {
                            if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                            if (blob) resolve(blob); else reject(new Error("Compression failed"));
                        }, 'image/jpeg', 0.6);
                    };
                };
            });
        };

        const copyDayItinerary = (day, nodes, dayLabel) => {
            const dayNodes = nodes.filter(n => (n.day || 1) === parseInt(day)).sort((a,b) => {
                const tA = a.departureTime || a.pickupTime || a.checkIn || a.startTime || '9999';
                const tB = b.departureTime || b.pickupTime || b.checkIn || b.startTime || '9999';
                return tA.localeCompare(tB);
            });

            let text = `ğŸ“… Day ${day} - ${dayLabel || 'è¡Œç¨‹'}\n------------------\n`;
            dayNodes.forEach(node => {
                const time = node.departureTime || node.pickupTime || node.checkIn || node.startTime;
                const timeStr = time ? new Date(time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                let icon = 'ğŸ“';
                if (node.type === 'flight') icon = 'âœˆï¸';
                if (node.type === 'rental') icon = 'ğŸš—';
                if (node.type === 'hotel') icon = 'ğŸ¨';
                text += `${timeStr} ${icon} ${node.title}\n`;
                if (node.address) text += `      ğŸ“: ${node.address}\n`;
                if (node.gps) text += `      ğŸŒ: ${node.gps}\n`;
                if (node.cost) text += `      ğŸ’°: $${node.cost}\n`;
                if (node.memo) text += `      ğŸ’¡: ${node.memo}\n`;
                text += `\n`;
            });
            text += `------------------\nGenerated by TripSync`;
            if (copyToClipboard(text)) alert(`Day ${day} è¡Œç¨‹å·²è¤‡è£½ï¼`);
            else alert("è¤‡è£½å¤±æ•—");
        };

        const sanitizeNodeData = (node) => ({
            ...node,
            cost: node.cost ?? '', 
            feePercent: node.feePercent ?? '1.5',
            fuelCost: node.fuelCost ?? '',
            useForeignCurrency: node.useForeignCurrency || false,
            currency: node.currency || '',
            gps: node.gps || '',
            receiptUrl: node.receiptUrl || '',
            luggage: node.luggage || {}, 
            involvedMembers: node.involvedMembers || [],
            rentalExpenses: node.rentalExpenses || [],
            id: node.id || Date.now().toString() + Math.random().toString().slice(2)
        });

        // --- Design Tokens ---
        const theme = {
            bg: "bg-[#fdfbf7]", 
            text: "text-slate-700",
            accent: "text-slate-800",
            money: "text-emerald-700 bg-emerald-50 border-emerald-200", 
            potential: "text-purple-700 bg-purple-50 border-purple-200 border-dashed", 
            flight: "text-sky-700 bg-sky-50 border-sky-200", 
            rental: "text-orange-700 bg-orange-50 border-orange-200", 
            hotel: "text-amber-700 bg-amber-50 border-amber-200", 
            card: "bg-white border-2 border-slate-100 shadow-[0_2px_0_0_rgba(203,213,225,1)] rounded-xl",
            input: "bg-[#fcfcfc] border border-slate-300 rounded-lg px-3 py-2 text-sm focus:border-slate-500 outline-none transition-colors w-full resize-none",
            btnPrimary: "bg-slate-800 text-white px-4 py-2 rounded-lg font-bold shadow-md active:scale-95 transition-all",
        };

        // --- Components ---

        const Label = ({ icon, text }) => (
            <label className="text-[10px] font-bold uppercase opacity-60 flex items-center gap-1 mb-1.5 text-slate-700">{icon} {text}</label>
        );

        const getMemberIcon = (index) => {
            const icons = [Smile, Ghost, Gamepad2, Coffee, Music, Sun];
            const colors = ['text-rose-500', 'text-indigo-500', 'text-emerald-500', 'text-amber-500', 'text-sky-500', 'text-orange-500'];
            const Icon = icons[index % icons.length];
            return <Icon className={`w-6 h-6 ${colors[index % colors.length]}`} />;
        };

        const MemberAvatar = ({ member, index, onClick }) => (
            <div onClick={onClick} className="flex flex-col items-center cursor-pointer group relative">
                <div className="w-12 h-12 rounded-full bg-white border-2 border-slate-200 flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform group-hover:border-slate-800 overflow-hidden">
                    {getMemberIcon(index)}
                </div>
                <span className="text-[10px] font-bold text-slate-500 mt-1 truncate max-w-[60px]">{member.name}</span>
            </div>
        );

        const OverviewIcon = ({ type }) => {
            switch(type) {
                case 'flight': return <Plane className="w-3 h-3 text-sky-600"/>;
                case 'hotel': return <Home className="w-3 h-3 text-amber-600"/>;
                case 'rental': return <Car className="w-3 h-3 text-orange-600"/>;
                default: return <MapPin className="w-3 h-3 text-slate-400"/>;
            }
        };

        const RentalExpenses = ({ node, onChange }) => {
            const expenses = node.rentalExpenses || [];
            const addExpense = () => onChange('rentalExpenses', [...expenses, { id: Date.now(), label: '', cost: '' }]);
            const updateExpense = (idx, key, val) => {
                const newExps = [...expenses];
                newExps[idx][key] = val;
                onChange('rentalExpenses', newExps);
            };
            const removeExpense = (idx) => onChange('rentalExpenses', expenses.filter((_, i) => i !== idx));

            return (
                <div className="mt-4 space-y-2 bg-orange-50/50 p-3 rounded-xl border border-orange-100">
                    <label className="text-[10px] font-bold text-orange-700 uppercase flex items-center gap-1"><CreditCard className="w-3 h-3"/> ç§Ÿè»Šé¡å¤–æ”¯å‡º (ETC/å°èˆª/å…’ç«¥åº§æ¤…)</label>
                    {expenses.map((exp, idx) => (
                        <div key={exp.id} className="flex gap-2 items-center">
                            <input placeholder="é …ç›®" className="flex-1 bg-white border border-orange-200 rounded px-2 py-1 text-xs text-slate-700 outline-none" value={exp.label} onChange={(e) => updateExpense(idx, 'label', e.target.value)} />
                            <input type="number" placeholder="$" className="w-20 bg-white border border-orange-200 rounded px-2 py-1 text-xs font-mono text-slate-700 outline-none" value={exp.cost} onChange={(e) => updateExpense(idx, 'cost', e.target.value)} />
                            <button onClick={() => removeExpense(idx)} className="text-orange-300 hover:text-orange-600"><X className="w-4 h-4"/></button>
                        </div>
                    ))}
                    <button onClick={addExpense} className="w-full py-1.5 border border-dashed border-orange-300 rounded-lg text-xs font-bold text-orange-500 hover:bg-orange-100 transition-colors flex items-center justify-center gap-1"><Plus className="w-3 h-3" /> æ–°å¢è²»ç”¨é …ç›®</button>
                </div>
            );
        };

        const ExpenseCalculator = ({ node, members, currencies, onChange }) => {
            const baseCost = parseFloat(node.cost) || 0;
            const feePercent = parseFloat(node.feePercent) || 0;
            const rentalExtraSum = (node.rentalExpenses || []).reduce((acc, curr) => acc + (parseFloat(curr.cost) || 0), 0);
            
            let estimatedTWD = baseCost;
            let currentRate = 1;

            if (node.useForeignCurrency) {
                const selectedCurrency = currencies.find(c => c.name === node.currency);
                currentRate = selectedCurrency ? parseFloat(selectedCurrency.rate) : 1;
                estimatedTWD = Math.round(baseCost * currentRate);
            }
            
            const totalBaseWithExtras = baseCost + rentalExtraSum;
            const totalEstimatedTWD = Math.round(totalBaseWithExtras * currentRate);
            const totalConfirmedTWD = Math.round(totalEstimatedTWD * (1 + feePercent / 100));
            
            const involvedIds = node.involvedMembers || members.map(m => m.id);
            const perPerson = involvedIds.length > 0 ? Math.round(totalConfirmedTWD / involvedIds.length) : 0;

            const toggleMember = (mId) => {
                let newInvolved = involvedIds.includes(mId) ? involvedIds.filter(id => id !== mId) : [...involvedIds, mId];
                onChange('involvedMembers', newInvolved);
            };

            const isPotential = node.isPotential || false;

            return (
                <div className={`mt-4 p-4 rounded-xl border-2 flex flex-col gap-3 transition-colors ${isPotential ? 'text-purple-700 bg-purple-50 border-purple-200 border-dashed' : 'text-emerald-700 bg-emerald-50 border-emerald-200'}`}>
                    <div className="flex justify-between items-center mb-1">
                        <div className="flex items-center gap-2"><DollarSign className="w-4 h-4" /><span className="font-bold text-sm">{isPotential ? 'æ½›åœ¨é ç®—' : 'ç¢ºèªè²»ç”¨'}</span></div>
                        <div className="flex gap-2">
                            <label className="flex items-center gap-1 text-[10px] font-bold cursor-pointer select-none bg-white/50 px-2 py-1 rounded"><input type="checkbox" checked={node.useForeignCurrency} onChange={(e) => onChange('useForeignCurrency', e.target.checked)} className="rounded text-emerald-600 focus:ring-emerald-500"/><span className="text-emerald-700">ä½¿ç”¨å¤–å¹£</span></label>
                            <label className="flex items-center gap-1 text-[10px] font-bold cursor-pointer select-none bg-white/50 px-2 py-1 rounded"><input type="checkbox" checked={isPotential} onChange={(e) => onChange('isPotential', e.target.checked)} className="rounded text-purple-600 focus:ring-purple-500"/><span className="text-purple-700">åˆ—å…¥æ½›åœ¨</span></label>
                        </div>
                    </div>
                    
                    <div className="flex gap-2">
                        {node.useForeignCurrency && (
                            <div className="w-28">
                                <label className="text-[10px] font-bold opacity-70 block mb-1">é¸æ“‡å¹£åˆ¥</label>
                                <select className="w-full bg-white border border-current rounded-lg px-2 py-2 text-sm font-bold outline-none" value={node.currency} onChange={(e) => onChange('currency', e.target.value)}>
                                    <option value="">è«‹é¸æ“‡</option>
                                    {currencies.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                                </select>
                            </div>
                        )}
                        <div className="flex-1">
                            <label className="text-[10px] font-bold opacity-70 block mb-1">é‡‘é¡ {node.useForeignCurrency ? `(${node.currency || 'å¤–å¹£'})` : '(TWD)'}</label>
                            <input type="number" placeholder="0" className="w-full bg-white border border-current rounded-lg px-2 py-2 text-sm font-bold font-mono outline-none" value={node.cost || ''} onChange={(e) => onChange('cost', e.target.value)}/>
                        </div>
                    </div>

                    {node.useForeignCurrency && node.currency && (
                        <div className="flex justify-between items-center text-xs bg-black/5 p-2 rounded">
                            <span className="opacity-60">åŒ¯ç‡: {currentRate}</span>
                            <span className="font-bold">â‰ˆ NT$ {Math.round(baseCost * currentRate).toLocaleString()}</span>
                        </div>
                    )}
                    
                    {node.type === 'rental' && rentalExtraSum > 0 && (
                        <div className="flex justify-between items-center text-xs bg-orange-50 text-orange-700 p-2 rounded border border-orange-100">
                            <span>é¡å¤–é …ç›® (ETC/å°èˆª/åº§æ¤…ç­‰)</span><span className="font-bold">+ {rentalExtraSum.toLocaleString()}</span>
                        </div>
                    )}

                    <div className="grid grid-cols-2 gap-3 mt-1">
                        <div><label className="text-[10px] font-bold opacity-70 block mb-1">æ‰‹çºŒè²» (%)</label><input type="number" placeholder="1.5" className="w-full bg-white border border-current rounded-lg px-2 py-2 text-sm font-bold font-mono outline-none" value={node.feePercent || ''} onChange={(e) => onChange('feePercent', e.target.value)}/></div>
                        {node.type === 'rental' && (
                            <div><label className="text-[10px] font-bold opacity-70 block mb-1 text-orange-600">é ä¼°æ²¹è³‡ (ä¸è¨ˆå…¥ç¸½é¡)</label><input type="number" placeholder="0" className="w-full bg-white border border-orange-200 rounded-lg px-2 py-2 text-sm font-bold font-mono text-orange-600 outline-none" value={node.fuelCost || ''} onChange={(e) => onChange('fuelCost', e.target.value)}/></div>
                        )}
                    </div>

                    <div className="mt-2">
                        <label className="text-[10px] font-bold opacity-70 block mb-2">åˆ†æ”¤æˆå“¡</label>
                        <div className="flex flex-wrap gap-2">
                            {members.length === 0 && <span className="text-xs italic opacity-50">è«‹å…ˆæ–°å¢æˆå“¡</span>}
                            {members.map(m => (
                                <button key={m.id} onClick={() => toggleMember(m.id)} className={`px-3 py-1 rounded-full text-xs font-bold border-2 transition-all ${involvedIds.includes(m.id) ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-400 border-slate-200'}`}>{m.name}</button>
                            ))}
                        </div>
                    </div>

                    <div className="flex justify-between items-end border-t border-current/20 pt-3 mt-1">
                        <div className="text-xs font-bold opacity-80">ç¸½è¨ˆ (TWD): ${totalConfirmedTWD.toLocaleString()}</div>
                        <div className="text-right">
                            <div className="text-[10px] opacity-70">æ¯äººå‡æ”¤</div>
                            <div className="text-lg font-black font-mono">${perPerson.toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const MemberInventory = ({ member, tripId }) => {
            const [newItem, setNewItem] = useState('');
            const [items, setItems] = useState(Array.isArray(member.inventory) ? member.inventory : []);
            const updateDB = async (newItems) => {
                setItems(newItems);
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'trips', tripId);
                try {
                    const tripSnap = await getDoc(docRef);
                    if(tripSnap.exists()){
                        const tripData = tripSnap.data();
                        const updatedMembers = tripData.members.map(m => m.id === member.id ? { ...m, inventory: newItems } : m);
                        await updateDoc(docRef, { members: updatedMembers });
                    }
                } catch(e) { console.error(e); }
            };
            const add = () => { if(!newItem.trim()) return; updateDB([...items, { id: Date.now(), name: newItem, checked: false }]); setNewItem(''); };
            const toggle = (id) => updateDB(items.map(i => i.id === id ? { ...i, checked: !i.checked } : i));
            const remove = (id) => updateDB(items.filter(i => i.id !== id));
            
            const equipped = items.filter(i => i.checked);
            const backpack = items.filter(i => !i.checked);

            return (
                <div className="h-full flex flex-col">
                    <div className="flex gap-2 mb-4">
                        <input value={newItem} onChange={e => setNewItem(e.target.value)} placeholder="æ–°å¢è£å‚™..." className="flex-1 bg-[#333] border-none rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-[#fbbf24]" onKeyDown={e => e.key === 'Enter' && add()}/>
                        <button onClick={add} className="bg-[#fbbf24] text-black px-3 rounded-lg"><Plus className="w-5 h-5"/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto space-y-4">
                        {backpack.length > 0 && <div>
                            <h4 className="text-xs font-bold text-slate-500 uppercase mb-2">æœªæ”œå¸¶</h4>
                            {backpack.map(item => (
                                <div key={item.id} className="flex items-center justify-between p-2 rounded-lg bg-[#333] border border-[#444] mb-1">
                                    <div className="flex items-center gap-2 cursor-pointer" onClick={() => toggle(item.id)}>
                                        <div className="w-4 h-4 rounded border border-slate-500"></div>
                                        <span className="text-sm text-slate-200">{item.name}</span>
                                    </div>
                                    <button onClick={() => remove(item.id)}><X className="w-4 h-4 text-slate-500"/></button>
                                </div>
                            ))}
                        </div>}
                        {equipped.length > 0 && <div>
                            <h4 className="text-xs font-bold text-emerald-500 uppercase mb-2">å·²æº–å‚™</h4>
                            {equipped.map(item => (
                                <div key={item.id} className="flex items-center justify-between p-2 rounded-lg bg-[#2a2a2a] border border-emerald-900/50 mb-1 opacity-60">
                                    <div className="flex items-center gap-2 cursor-pointer" onClick={() => toggle(item.id)}>
                                        <div className="w-4 h-4 rounded bg-emerald-600 flex items-center justify-center"><Check className="w-3 h-3 text-black"/></div>
                                        <span className="text-sm text-slate-400 line-through">{item.name}</span>
                                    </div>
                                    <button onClick={() => remove(item.id)}><X className="w-4 h-4 text-slate-600"/></button>
                                </div>
                            ))}
                        </div>}
                    </div>
                </div>
            );
        };

        const MemberRPGModal = ({ member, stats, tripId, onClose }) => {
            const [activeTab, setActiveTab] = useState('inventory');
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md p-4 animate-in zoom-in-95">
                    <div className="bg-[#2a2a2a] rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden border-4 border-[#4a4a4a] flex flex-col max-h-[85vh] text-slate-200">
                        <div className="bg-[#1a1a1a] p-6 text-center relative shrink-0 border-b-2 border-[#333]">
                            <button onClick={onClose} className="absolute top-4 right-4 p-2 hover:bg-white/10 rounded-full transition-colors"><X className="w-5 h-5 text-slate-400"/></button>
                            <div className="w-24 h-24 bg-[#2a2a2a] rounded-full mx-auto mb-3 flex items-center justify-center border-4 border-[#fbbf24] shadow-[0_0_15px_rgba(251,191,36,0.3)]">{getMemberIcon(stats.index)}</div>
                            <h3 className="text-2xl font-black text-[#fbbf24]">{member.name}</h3>
                            <div className="flex justify-center gap-2 mt-6 bg-[#111] p-1 rounded-full mx-4">
                                {['inventory', 'stats'].map(tab => (
                                    <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 py-2 rounded-full text-xs font-bold uppercase ${activeTab === tab ? 'bg-[#333] text-white' : 'text-slate-500'}`}>{tab === 'stats' ? 'è³‡è¨Š' : 'è£å‚™'}</button>
                                ))}
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto bg-[#252525] p-6">
                            {activeTab === 'stats' ? (
                                <div className="space-y-4">
                                    <div className="bg-[#333] rounded-xl p-4 border border-[#444]"><div className="text-xs text-slate-400 uppercase">ç¢ºèªæ”¯å‡º (TWD)</div><div className="text-2xl font-black text-emerald-400">${stats.actual.toLocaleString()}</div></div>
                                    <div className="bg-[#333] rounded-xl p-4 border border-[#444]"><div className="text-xs text-slate-400 uppercase">æ½›åœ¨é ç®—</div><div className="text-2xl font-black text-purple-400">${stats.potential.toLocaleString()}</div></div>
                                    <div className="bg-[#333] rounded-xl p-4 border border-[#444]"><div className="text-xs text-slate-400 uppercase mb-2">è¡Œæè² é‡</div><div className="flex gap-4"><div className="flex-1 bg-[#222] p-2 rounded text-center"><span className="text-xs text-slate-500">æ‰˜é‹</span><div className="font-bold text-sky-400">{stats.luggage.checked || 0}</div></div><div className="flex-1 bg-[#222] p-2 rounded text-center"><span className="text-xs text-slate-500">æ‰‹æ</span><div className="font-bold text-sky-400">{stats.luggage.carry || 0}</div></div></div></div>
                                </div>
                            ) : <MemberInventory member={member} tripId={tripId} />}
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ currencies, onUpdateCurrencies, onClose }) => {
            const [localCurrencies, setLocalCurrencies] = useState(currencies || []);
            const [newName, setNewName] = useState('');
            const [newRate, setNewRate] = useState('');

            const addCurrency = () => {
                if(!newName || !newRate) return;
                setLocalCurrencies([...localCurrencies, { id: Date.now(), name: newName, rate: parseFloat(newRate) }]);
                setNewName('');
                setNewRate('');
            };

            const removeCurrency = (id) => {
                setLocalCurrencies(localCurrencies.filter(c => c.id !== id));
            };

            const handleSave = () => { onUpdateCurrencies(localCurrencies); onClose(); };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-6 animate-in zoom-in-95">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 flex flex-col max-h-[80vh]">
                        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><Globe className="w-5 h-5"/> åŒ¯ç‡è¨­å®š (è‡ªå®šç¾©)</h3>
                        
                        <div className="flex gap-2 mb-4 p-3 bg-slate-50 rounded-xl border border-slate-200">
                            <input placeholder="å¹£åˆ¥ (å¦‚: æ³°éŠ–)" className="flex-1 bg-white border border-slate-300 rounded px-2 py-1 text-sm outline-none" value={newName} onChange={e => setNewName(e.target.value)} />
                            <input type="number" placeholder="åŒ¯ç‡" className="w-20 bg-white border border-slate-300 rounded px-2 py-1 text-sm outline-none" value={newRate} onChange={e => setNewRate(e.target.value)} />
                            <button onClick={addCurrency} className="bg-slate-800 text-white rounded px-3 text-sm font-bold"><Plus className="w-4 h-4"/></button>
                        </div>

                        <div className="flex-1 overflow-y-auto space-y-2 mb-4">
                            {localCurrencies.length === 0 && <div className="text-center text-slate-400 text-xs py-4">é è¨­åƒ…ä½¿ç”¨ TWDï¼Œè«‹æ–°å¢å¤–å¹£</div>}
                            {localCurrencies.map(c => (
                                <div key={c.id} className="flex justify-between items-center p-3 bg-white border border-slate-200 rounded-xl">
                                    <div>
                                        <span className="font-bold text-slate-700 block">{c.name}</span>
                                        <span className="text-xs text-slate-400">åŒ¯ç‡: {c.rate}</span>
                                    </div>
                                    <button onClick={() => removeCurrency(c.id)} className="text-slate-300 hover:text-rose-500"><Trash2 className="w-4 h-4"/></button>
                                </div>
                            ))}
                        </div>

                        <div className="flex gap-2 shrink-0">
                            <button onClick={onClose} className="flex-1 py-2 text-slate-500 font-bold bg-slate-100 rounded-lg">å–æ¶ˆ</button>
                            <button onClick={handleSave} className="flex-1 py-2 text-white font-bold bg-slate-800 rounded-lg shadow-lg">å„²å­˜è¨­å®š</button>
                        </div>
                    </div>
                </div>
            );
        };

        const TripOverviewModal = ({ tripData, stats, onClose }) => {
            const totalConfirmed = Object.values(stats).reduce((acc, curr) => acc + curr.actual, 0);
            const groupedItinerary = {};
            [...tripData.nodes].sort((a,b) => (a.day || 1) - (b.day || 1)).forEach(node => {
                const d = node.day || 1;
                if (!groupedItinerary[d]) groupedItinerary[d] = [];
                groupedItinerary[d].push(node);
            });

            const getTime = (node) => {
                const t = node.departureTime || node.pickupTime || node.checkIn || node.startTime;
                return t ? new Date(t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--';
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-6 animate-in zoom-in-95">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden relative flex flex-col max-h-[85vh]">
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 bg-slate-100 hover:bg-slate-200 rounded-full z-10"><X className="w-5 h-5"/></button>
                        <div className="p-6 pb-2 shrink-0 border-b border-slate-100">
                            <h2 className="text-xl font-black text-slate-800">è¡Œç¨‹ç¸½è¦½</h2>
                            <p className="text-slate-400 text-xs font-bold uppercase tracking-widest truncate max-w-[200px]">{tripData.name}</p>
                        </div>
                        <div className="flex-1 overflow-y-auto p-0">
                            <div className="bg-slate-900 p-6 text-white">
                                <div className="flex justify-between items-end mb-2">
                                    <span className="text-xs text-slate-400 font-bold uppercase">ç¸½ç¢ºèªæ”¯å‡º (TWD)</span>
                                    <span className="text-2xl font-black text-emerald-400 font-mono">${totalConfirmed.toLocaleString()}</span>
                                </div>
                            </div>
                            <div className="p-6 space-y-6">
                                {Object.keys(groupedItinerary).map(day => (
                                    <div key={day} className="relative pl-4 border-l-2 border-slate-100">
                                        <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-100 border-4 border-white flex items-center justify-center"><div className="w-1.5 h-1.5 rounded-full bg-slate-300"></div></div>
                                        <div className="mb-3 flex items-center gap-2"><span className="text-sm font-black text-slate-800">Day {day}</span><span className="text-xs font-medium text-slate-400">{(tripData.dayLabels && tripData.dayLabels[day]) || ''}</span></div>
                                        <div className="space-y-2">
                                            {groupedItinerary[day].map((node, i) => (
                                                <div key={i} className="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50 transition-colors">
                                                    <div className="w-10 text-[10px] font-mono text-slate-400 text-right">{getTime(node)}</div>
                                                    <div className="flex-1 min-w-0"><div className="flex items-center gap-1.5"><OverviewIcon type={node.type}/><span className="text-xs font-bold text-slate-700 truncate">{node.title}</span></div></div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const NodeCard = ({ node, index, members, existingDays, currencies, onUpdate, onDeleteRequest, onReorder, onDragStart, onDragOver, onDrop, isDragging, tripId }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [expanded, setExpanded] = useState(true);
            const [isUploading, setIsUploading] = useState(false);

            const getStyle = () => {
                if (node.isPotential) return 'text-purple-700 bg-purple-50 border-purple-200 border-dashed bg-white';
                switch(node.type) {
                    case 'flight': return 'text-sky-700 bg-sky-50 border-sky-200 bg-white';
                    case 'hotel': return 'text-amber-700 bg-amber-50 border-amber-200 bg-white';
                    case 'rental': return 'text-orange-700 bg-orange-50 border-orange-200 bg-white';
                    default: return "border-slate-200 bg-white";
                }
            };

            const Icon = node.type === 'flight' ? Plane : node.type === 'hotel' ? Home : node.type === 'rental' ? Car : FileText;
            const handleFieldChange = (key, value) => onUpdate(index, { ...node, [key]: value });

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setIsUploading(true);
                try {
                    const compressedBlob = await compressImage(file);
                    const fileName = `receipt_${Date.now()}.jpg`;
                    const storageRef = ref(storage, `receipts/${tripId}/${node.id}/${fileName}`);
                    const snapshot = await uploadBytes(storageRef, compressedBlob);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    handleFieldChange('receiptUrl', downloadURL);
                } catch (error) { console.error(error); alert("ä¸Šå‚³å¤±æ•—"); } finally { setIsUploading(false); }
            };

            if (!isEditing) {
                return (
                    <div className={`mb-3 transition-all group ${isDragging ? 'opacity-30 scale-95' : 'opacity-100'}`} draggable onDragStart={(e) => onDragStart(e, index)} onDragOver={(e) => onDragOver(e)} onDrop={(e) => onDrop(e, index)}>
                        <div className={`rounded-xl border-2 shadow-sm relative overflow-hidden transition-transform ${getStyle()}`}>
                            <div className="p-4 flex items-start gap-3 cursor-pointer" onClick={() => setExpanded(!expanded)}>
                                <div className="p-2 -ml-2 cursor-grab active:cursor-grabbing text-slate-300 hover:text-slate-500 flex items-center"><GripVertical className="w-4 h-4" /></div>
                                <div className={`p-2.5 rounded-xl bg-white/60 border border-current shadow-sm`}><Icon className="w-5 h-5 opacity-80" /></div>
                                <div className="flex-1 min-w-0 pt-1">
                                    <div className="flex justify-between items-start"><h3 className="font-bold text-lg leading-tight truncate pr-2">{node.title || 'æœªå‘½åé …ç›®'}</h3><div className="text-current opacity-50">{expanded ? <ChevronUp className="w-4 h-4"/> : <ChevronDown className="w-4 h-4"/>}</div></div>
                                    <div className="flex flex-wrap gap-2 mt-2">
                                        {node.isPotential && <span className="text-[10px] font-bold bg-purple-100 text-purple-700 px-2 py-0.5 rounded border border-purple-200 flex items-center gap-1"><AlertCircle className="w-3 h-3"/> æ½›åœ¨</span>}
                                        {(node.departureTime || node.pickupTime || node.checkIn || node.startTime) && <span className="text-[10px] font-bold bg-white/50 px-2 py-0.5 rounded border border-current opacity-80 font-mono">{new Date(node.departureTime || node.pickupTime || node.checkIn || node.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>}
                                        {node.type === 'rental' && node.company && <span className="text-[10px] font-bold bg-orange-100 text-orange-700 px-2 py-0.5 rounded border border-orange-200">{node.company}</span>}
                                    </div>
                                </div>
                            </div>
                            {expanded && <div className="px-4 pb-4 pt-0 border-t border-black/5 animate-in">
                                <div className="mt-3 space-y-3 text-sm">
                                    {node.gps && (
                                        <div className="flex gap-1 mb-3" onClick={e=>e.stopPropagation()}>
                                            <button onClick={() => {if(copyToClipboard(node.gps)) alert("GPS å·²è¤‡è£½")}} className="flex items-center gap-1 text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-1 rounded border border-slate-200 hover:bg-slate-200"><Copy className="w-3 h-3"/> {node.gps}</button>
                                            <a href={`https://www.google.com/maps/search/?api=1&query=${node.gps}`} target="_blank" rel="noreferrer" className="flex items-center gap-1 text-[10px] font-bold bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100 hover:bg-blue-100"><Map className="w-3 h-3"/> é–‹å•Ÿåœ°åœ–</a>
                                        </div>
                                    )}
                                    {node.type === 'flight' && (
                                        <div className="bg-sky-50/80 p-2 rounded border border-sky-100 text-xs">
                                            <div className="grid grid-cols-[80px_1fr_1fr] gap-2 mb-1 opacity-60 font-bold"><div>æˆå“¡</div><div>æ‰˜é‹</div><div>æ‰‹æ</div></div>
                                            {members.map(m => {
                                                const lug = (node.luggage || {})[m.id] || {};
                                                return <div key={m.id} className="grid grid-cols-[80px_1fr_1fr] gap-2 py-1 border-t border-sky-200/50"><div className="truncate font-bold">{m.name}</div><div className="font-mono">{lug.checked||'-'}</div><div className="font-mono">{lug.carry||'-'}</div></div>
                                            })}
                                        </div>
                                    )}
                                    {node.type === 'rental' && (
                                        <div className="bg-white/50 p-3 rounded-lg space-y-2 text-xs">
                                            <div className="grid grid-cols-2 gap-2"><div><span className="opacity-50 block">å…¬å¸</span><b>{node.company}</b></div><div><span className="opacity-50 block">è»Šå‹</span><b>{node.carModel}</b></div></div>
                                            <div className="grid grid-cols-2 gap-2 pt-2 border-t border-black/5"><div><span className="opacity-50 block">å–</span><span className="font-mono">{node.pickupTime?new Date(node.pickupTime).toLocaleString():'--'}</span></div><div><span className="opacity-50 block">é‚„</span><span className="font-mono">{node.dropoffTime?new Date(node.dropoffTime).toLocaleString():'--'}</span></div></div>
                                            {node.rentalExpenses && node.rentalExpenses.length > 0 && <div className="pt-2 border-t border-black/5"><span className="opacity-50 block mb-1">é¡å¤–æ”¯å‡º</span>{node.rentalExpenses.map(e => <div key={e.id} className="flex justify-between font-mono"><span>{e.label}</span><span>${e.cost}</span></div>)}</div>}
                                        </div>
                                    )}
                                    {node.type === 'hotel' && node.meals && (
                                        <div className="flex gap-2 text-xs font-bold text-amber-700 bg-amber-100/50 p-2 rounded w-fit"><Utensils className="w-3 h-3"/> {node.meals.breakfast&&<span>æ—©é¤</span>}{node.meals.lunch&&<span>åˆé¤</span>}{node.meals.dinner&&<span>æ™šé¤</span>}</div>
                                    )}
                                    {node.memo && <div className="whitespace-pre-wrap bg-white/50 p-2 rounded text-slate-600 border border-black/5 text-xs leading-relaxed">{node.memo}</div>}
                                    <div className="pt-2 border-t border-black/5">
                                        {isUploading ? <div className="flex items-center gap-2 text-xs text-slate-500"><Loader className="w-3 h-3 animate-spin"/> ä¸Šå‚³ä¸­...</div> : node.receiptUrl ? <div className="flex items-center gap-3"><a href={node.receiptUrl} target="_blank" className="flex items-center gap-1 text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-100 hover:bg-blue-100"><Paperclip className="w-3 h-3"/> æŸ¥çœ‹æ†‘è­‰</a><label className="cursor-pointer text-[10px] text-slate-400 hover:text-slate-600 underline">æ›´æ›<input type="file" accept="image/*" className="hidden" onChange={handleFileUpload} /></label></div> : <label className="flex items-center gap-1 text-xs font-bold text-slate-400 hover:text-slate-600 cursor-pointer w-fit border border-dashed border-slate-300 px-2 py-1 rounded hover:bg-white transition-colors"><Camera className="w-3 h-3"/> ä¸Šå‚³æ”¶æ“š<input type="file" accept="image/*" className="hidden" onChange={handleFileUpload} /></label>}
                                    </div>
                                    <div className="flex justify-between items-end pt-2">
                                        <div className="flex gap-1" onClick={(e)=>e.stopPropagation()}>
                                            <button onClick={() => onReorder(index, -1)} className="p-1 hover:bg-black/5 rounded text-slate-400"><ArrowUp className="w-4 h-4"/></button>
                                            <button onClick={() => onReorder(index, 1)} className="p-1 hover:bg-black/5 rounded text-slate-400"><ArrowDown className="w-4 h-4"/></button>
                                            <button onClick={() => setIsEditing(true)} className="p-1 bg-slate-800 text-white rounded shadow ml-2 hover:bg-slate-700"><Edit3 className="w-4 h-4"/></button>
                                            <button onClick={() => onDeleteRequest(index)} className="p-1 bg-white border border-slate-200 text-slate-300 hover:text-rose-500 rounded ml-1"><Trash2 className="w-4 h-4"/></button>
                                        </div>
                                        {node.cost > 0 && <div className={`font-mono font-bold text-xs flex items-center gap-1 ${node.isPotential ? 'text-purple-700' : 'text-emerald-700'}`}><DollarSign className="w-3 h-3"/> ${parseInt(node.cost * ((node.useForeignCurrency && currencies.find(c=>c.name===node.currency)?.rate) || 1)).toLocaleString()} (TWD)</div>}
                                    </div>
                                </div>
                            </div>}
                        </div>
                    </div>
                );
            }

            return (
                <div className="mb-6 ml-4 rounded-xl border-2 border-slate-800 shadow-2xl bg-white overflow-hidden animate-in zoom-in-95 relative z-20">
                    <div className="bg-slate-800 text-white px-4 py-3 flex justify-between items-center"><span className="text-xs font-bold uppercase flex items-center gap-2"><Edit3 className="w-4 h-4"/> ç·¨è¼¯é …ç›®</span><button onClick={() => setIsEditing(false)} className="hover:bg-slate-700 p-1 rounded"><X className="w-5 h-5"/></button></div>
                    <div className="p-5 space-y-5">
                        <div className="space-y-3">
                            <Label text="æ¨™é¡Œ" icon={<FileText className="w-3 h-3"/>} />
                            <textarea rows="1" value={node.title} onChange={e => handleFieldChange('title', e.target.value)} className={`${theme.input} font-bold text-base border-slate-400`} />
                            <div>
                                <Label icon={<Calendar className="w-3 h-3"/>} text="åˆ†é…å¤©æ•¸" />
                                <div className="flex flex-wrap gap-2 items-center">
                                    <div className="relative"><span className="absolute left-3 top-2 text-xs font-bold text-slate-400">Day</span><input type="number" min="1" className="w-20 pl-10 pr-2 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-bold outline-none focus:border-slate-800" value={node.day || ''} onChange={(e) => handleFieldChange('day', parseInt(e.target.value) || 1)} /></div>
                                    {existingDays.filter(d => d !== node.day).map(d => (<button key={d} onClick={() => handleFieldChange('day', d)} className="px-2 py-1.5 rounded-lg text-xs font-bold bg-white border border-slate-200 text-slate-500 hover:bg-slate-50">Day {d}</button>))}
                                </div>
                            </div>
                        </div>
                        <div>
                            <Label text="åœ°é»è³‡è¨Š" icon={<MapPin className="w-3 h-3"/>} />
                            <div className="space-y-2">
                                <input placeholder="GPS ç¶“ç·¯åº¦ (å¦‚: 25.033, 121.565)" className={`${theme.input} font-mono text-xs`} value={node.gps || ''} onChange={e => handleFieldChange('gps', e.target.value)} />
                                <textarea rows="1" placeholder="åœ°å€ (åƒ…ä¾›é¡¯ç¤º)..." value={node.address || ''} onChange={e => handleFieldChange('address', e.target.value)} className={`${theme.input} text-blue-600`} />
                            </div>
                        </div>
                        {node.type === 'flight' && (
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-4"><div><Label text="èµ·é£›" icon={<PlaneTakeoff className="w-3 h-3"/>}/><input type="datetime-local" value={node.departureTime || ''} onChange={e => handleFieldChange('departureTime', e.target.value)} className={`${theme.input}`} /></div><div><Label text="æŠµé”" icon={<PlaneLanding className="w-3 h-3"/>}/><input type="datetime-local" value={node.arrivalTime || ''} onChange={e => handleFieldChange('arrivalTime', e.target.value)} className={`${theme.input}`} /></div></div>
                                <div className="bg-sky-50 p-3 rounded-xl border border-sky-100">
                                    <div className="flex items-center gap-2 mb-2"><Luggage className="w-4 h-4 text-sky-600"/><span className="text-xs font-bold text-sky-800">è¡Œæé¡åº¦</span></div>
                                    {members.map(m => {
                                        const md = (node.luggage || {})[m.id] || {};
                                        return <div key={m.id} className="grid grid-cols-[80px_1fr_1fr] gap-2 items-center mb-2 last:mb-0"><span className="text-xs font-bold truncate">{m.name}</span><input placeholder="æ‰˜é‹" className="text-xs px-2 py-1 rounded border border-sky-200 w-full" value={md.checked||''} onChange={e=>onUpdate(index, {...node, luggage: {...(node.luggage||{}), [m.id]: {...md, checked: e.target.value}}})}/><input placeholder="æ‰‹æ" className="text-xs px-2 py-1 rounded border border-sky-200 w-full" value={md.carry||''} onChange={e=>onUpdate(index, {...node, luggage: {...(node.luggage||{}), [m.id]: {...md, carry: e.target.value}}})}/></div>
                                    })}
                                </div>
                            </div>
                        )}
                        {node.type === 'rental' && (
                            <div className="space-y-3">
                                <div className="grid grid-cols-2 gap-3"><div><Label text="å…¬å¸" icon={<Car className="w-3 h-3"/>}/><input value={node.company || ''} onChange={e => handleFieldChange('company', e.target.value)} className={`${theme.input}`} /></div><div><Label text="è»Šå‹"/><input value={node.carModel || ''} onChange={e => handleFieldChange('carModel', e.target.value)} className={`${theme.input}`} /></div></div>
                                <div className="grid grid-cols-2 gap-3 bg-orange-50/50 p-3 rounded-xl border border-orange-100"><div><Label text="å–è»Š" icon={<Calendar className="w-3 h-3"/>}/><input type="datetime-local" value={node.pickupTime || ''} onChange={e => handleFieldChange('pickupTime', e.target.value)} className={`${theme.input}`} /></div><div><Label text="é‚„è»Š" icon={<Calendar className="w-3 h-3"/>}/><input type="datetime-local" value={node.dropoffTime || ''} onChange={e => handleFieldChange('dropoffTime', e.target.value)} className={`${theme.input}`} /></div></div>
                                <RentalExpenses node={node} onChange={handleFieldChange} />
                            </div>
                        )}
                        {(node.type !== 'rental' && node.type !== 'flight') && (
                            <div className="grid grid-cols-2 gap-3"><div><Label text="é–‹å§‹" icon={<Calendar className="w-3 h-3"/>}/><input type="time" value={node.startTime || ''} onChange={e => handleFieldChange('startTime', e.target.value)} className={`${theme.input}`} /></div><div><Label text="çµæŸ" icon={<Calendar className="w-3 h-3"/>}/><input type="time" value={node.endTime || ''} onChange={e => handleFieldChange('endTime', e.target.value)} className={`${theme.input}`} /></div></div>
                        )}
                        <div><Label text="å‚™å¿˜éŒ„" icon={<FileText className="w-3 h-3"/>} /><textarea value={node.memo || ''} onChange={e => handleFieldChange('memo', e.target.value)} className={`${theme.input} h-24`} placeholder="è¼¸å…¥æ³¨æ„äº‹é …..." /></div>
                        <ExpenseCalculator node={node} members={members} currencies={currencies} onChange={handleFieldChange} />
                        <button onClick={() => setIsEditing(false)} className="w-full py-3 rounded-xl text-sm font-bold text-white bg-slate-800 shadow-lg flex items-center justify-center active:scale-95 transition-transform mt-4"><Check className="w-4 h-4 mr-2"/> å®Œæˆç·¨è¼¯</button>
                    </div>
                </div>
            );
        };

        const TripDetailScreen = ({ userId, tripId, onBack }) => {
            const [tripData, setTripData] = useState(null);
            const [showShare, setShowShare] = useState(false);
            const [isAdding, setIsAdding] = useState(false);
            const [deleteConfirmIndex, setDeleteConfirmIndex] = useState(null);
            const [showMemberModal, setShowMemberModal] = useState(false);
            const [newMemberName, setNewMemberName] = useState('');
            const [selectedMemberStats, setSelectedMemberStats] = useState(null);
            const [showOverview, setShowOverview] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [draggedNodeIndex, setDraggedNodeIndex] = useState(null);

            useEffect(() => {
                if (!tripId) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'trips', tripId);
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const cleanNodes = (data.nodes || []).map(sanitizeNodeData);
                        const cleanData = {
                            ...data,
                            nodes: cleanNodes,
                            members: data.members || [],
                            dayLabels: data.dayLabels || {},
                            currencies: data.currencies || [{id:1, name:'JPY', rate:0.21}, {id:2, name:'USD', rate:32}]
                        };
                        setTripData({ id: docSnap.id, ...cleanData });
                    }
                });
                return () => unsubscribe();
            }, [tripId]);

            const memberStats = useMemo(() => {
                if (!tripData) return {};
                const stats = {};
                const currencies = tripData.currencies || [];
                tripData.members.forEach((m, idx) => {
                    stats[m.id] = { index: idx, actual: 0, potential: 0, luggage: { checked: 0, carry: 0 } };
                });
                tripData.nodes.forEach(node => {
                    let currentRate = 1;
                    if(node.useForeignCurrency && node.currency) {
                        const curr = currencies.find(c => c.name === node.currency);
                        if(curr) currentRate = curr.rate;
                    }
                    const baseCost = parseFloat(node.cost) || 0;
                    const fuelCost = parseFloat(node.fuelCost) || 0;
                    const rentalExtras = (node.rentalExpenses || []).reduce((acc, c) => acc + (parseFloat(c.cost)||0), 0);
                    const totalBaseInTWD = Math.round((baseCost + rentalExtras) * currentRate);
                    if (totalBaseInTWD > 0) {
                        const totalNodeCost = totalBaseInTWD * (1 + (parseFloat(node.feePercent) || 0) / 100);
                        const involvedIds = node.involvedMembers || tripData.members.map(m => m.id);
                        const splitCost = involvedIds.length > 0 ? totalNodeCost / involvedIds.length : 0;
                        involvedIds.forEach(mId => {
                            if (stats[mId]) {
                                if (node.isPotential) stats[mId].potential += splitCost;
                                else stats[mId].actual += splitCost;
                            }
                        });
                    }
                    if (fuelCost > 0 && node.type === 'rental') {
                        const involvedIds = node.involvedMembers || tripData.members.map(m => m.id);
                        const splitFuel = involvedIds.length > 0 ? fuelCost / involvedIds.length : 0;
                        involvedIds.forEach(mId => {
                            if (stats[mId]) stats[mId].potential += splitFuel;
                        });
                    }
                    if (node.type === 'flight' && node.luggage) {
                        Object.entries(node.luggage).forEach(([mId, lug]) => {
                            if (stats[mId]) {
                                if(lug.checked) stats[mId].luggage.checked = lug.checked;
                                if(lug.carry) stats[mId].luggage.carry = lug.carry;
                            }
                        });
                    }
                });
                Object.keys(stats).forEach(k => {
                    stats[k].actual = Math.round(stats[k].actual);
                    stats[k].potential = Math.round(stats[k].potential);
                });
                return stats;
            }, [tripData]);

            const saveTrip = async (newData) => {
                setTripData(prev => ({ ...prev, ...newData })); 
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'trips', tripId);
                await updateDoc(docRef, newData);
            };

            const handleUpdateNode = (index, updatedNode) => {
                const newNodes = [...tripData.nodes];
                newNodes[index] = updatedNode;
                saveTrip({ nodes: newNodes });
            };

            const handleDragStart = (e, index) => { setDraggedNodeIndex(index); e.dataTransfer.effectAllowed = "move"; };
            const handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; };
            const handleDrop = (e, targetIndex) => {
                e.preventDefault();
                if (draggedNodeIndex === null || draggedNodeIndex === targetIndex) return;
                const newNodes = [...tripData.nodes];
                const [draggedItem] = newNodes.splice(draggedNodeIndex, 1);
                newNodes.splice(targetIndex, 0, draggedItem);
                const targetDay = newNodes[targetIndex+1]?.day || newNodes[targetIndex-1]?.day || draggedItem.day;
                if (targetDay && draggedItem.day !== targetDay) newNodes[targetIndex].day = targetDay;
                saveTrip({ nodes: newNodes });
                setDraggedNodeIndex(null);
            };

            const handleReorderNode = (index, direction) => {
                const newNodes = [...tripData.nodes];
                const targetIndex = index + direction;
                if (targetIndex < 0 || targetIndex >= newNodes.length) return;
                [newNodes[index], newNodes[targetIndex]] = [newNodes[targetIndex], newNodes[index]];
                saveTrip({ nodes: newNodes });
            };

            const handleUpdateDayLabel = (day, label) => {
                const newLabels = { ...(tripData.dayLabels || {}), [day]: label };
                saveTrip({ dayLabels: newLabels });
            };

            const handleDeleteRequest = (index) => setDeleteConfirmIndex(index);
            const confirmDelete = () => {
                if (deleteConfirmIndex === null) return;
                const newNodes = tripData.nodes.filter((_, i) => i !== deleteConfirmIndex);
                saveTrip({ nodes: newNodes });
                setDeleteConfirmIndex(null);
            };

            const handleAddNode = (type) => {
                const currentMaxDay = tripData.nodes.length > 0 ? Math.max(...tripData.nodes.map(n => n.day || 1)) : 1;
                const newNode = sanitizeNodeData({
                    type: type,
                    title: type === 'flight' ? 'æ–°èˆªç­' : type === 'rental' ? 'ç§Ÿè»Š' : type === 'hotel' ? 'ä½å®¿' : 'æ–°è¡Œç¨‹',
                    day: currentMaxDay,
                    cost: '',
                    feePercent: '1.5',
                    isPotential: false,
                });
                newNode.involvedMembers = tripData.members.map(m => m.id);
                saveTrip({ nodes: [...(tripData.nodes || []), newNode] });
                setIsAdding(false);
            };

            const handleAddMember = () => {
                if (!newMemberName.trim()) return;
                const newMember = { id: Date.now().toString(), name: newMemberName.trim(), inventory: [] };
                saveTrip({ members: [...(tripData.members || []), newMember] });
                setNewMemberName('');
            };

            const groupedNodes = {};
            const existingDays = [];
            if(tripData){
                tripData.nodes.forEach((node, index) => {
                    const d = node.day || 1;
                    if (!existingDays.includes(d)) existingDays.push(d);
                    if (!groupedNodes[d]) groupedNodes[d] = [];
                    groupedNodes[d].push({ ...node, originalIndex: index });
                });
                existingDays.sort((a,b) => a-b);
            }

            if (!tripData) return <div className="flex h-screen items-center justify-center text-slate-400">è¼‰å…¥æ—…ç¨‹ä¸­...</div>;

            return (
                <div className={`flex flex-col h-screen ${theme.bg} relative`}>
                    <div className="bg-white/90 backdrop-blur-md p-3 sticky top-0 z-30 border-b border-slate-200 shadow-sm flex flex-col gap-2">
                        <div className="flex justify-between items-center">
                            <button onClick={onBack} className="p-2 -ml-2 text-slate-600 rounded-full"><ArrowLeft className="w-5 h-5" /></button>
                            <h1 className="font-bold text-slate-800 truncate max-w-[150px]">{tripData.name}</h1>
                            <div className="flex gap-1">
                                <button onClick={() => setShowSettings(true)} className="p-2 text-slate-600 hover:bg-slate-100 rounded-full"><Settings className="w-5 h-5" /></button>
                                <button onClick={() => setShowOverview(true)} className="p-2 text-slate-600 hover:bg-slate-100 rounded-full"><Grid className="w-5 h-5" /></button>
                                <button onClick={() => { if(copyToClipboard(tripId)) alert("ID å·²è¤‡è£½"); }} className="p-2 -mr-2 text-slate-600 hover:bg-slate-100 rounded-full"><Share2 className="w-5 h-5" /></button>
                            </div>
                        </div>
                        <div className="flex gap-4 overflow-x-auto pb-1 scrollbar-hide justify-center px-4">
                            {tripData.members.map((m, idx) => (
                                <MemberAvatar key={m.id} member={m} index={idx} onClick={() => setSelectedMemberStats({ member: m, stats: memberStats[m.id] })} />
                            ))}
                            <button onClick={() => setShowMemberModal(true)} className="flex flex-col items-center justify-center min-w-[40px]">
                                <div className="w-12 h-12 rounded-full border-2 border-dashed border-slate-300 flex items-center justify-center text-slate-400 hover:border-slate-500 hover:text-slate-500"><Plus className="w-5 h-5" /></div>
                                <span className="text-[10px] mt-1 text-slate-400">æˆå“¡</span>
                            </button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 pb-32">
                        {Object.keys(groupedNodes).length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-full text-slate-300"><Tent className="w-16 h-16 mb-4 opacity-20" /><p>é»æ“Šä¸‹æ–¹ã€Œ+ã€é–‹å§‹</p></div>
                        ) : (
                            Object.keys(groupedNodes).sort((a,b)=>a-b).map(day => (
                                <div key={day} className="mb-8">
                                    <div className="sticky top-0 z-20 flex items-center gap-4 mb-6 pt-2 bg-[#fdfbf7]/90 backdrop-blur-sm pb-2">
                                        <div className="bg-slate-800 text-white px-3 py-1 rounded-full font-black text-xs shadow-md shrink-0">DAY {day}</div>
                                        <input type="text" placeholder={`è‡ªè¨‚æ¨™é¡Œ (å¦‚: æŠµé”${day === '1' ? 'é¦–æ—¥' : 'ç•¶å¤©'})`} className="bg-transparent border-b border-dashed border-slate-400 focus:border-slate-800 outline-none text-sm font-bold text-slate-600 placeholder:text-slate-300 w-full" value={(tripData.dayLabels && tripData.dayLabels[day]) || ''} onChange={(e) => handleUpdateDayLabel(day, e.target.value)} />
                                        <button onClick={() => copyDayItinerary(day, tripData.nodes, tripData.dayLabels[day])} className="p-2 bg-slate-200 text-slate-600 rounded-full hover:bg-slate-300"><Copy className="w-4 h-4" /></button>
                                    </div>
                                    {groupedNodes[day].map((nodeWithIdx) => (
                                        <NodeCard key={nodeWithIdx.originalIndex} index={nodeWithIdx.originalIndex} node={nodeWithIdx} members={tripData.members} existingDays={existingDays} currencies={tripData.currencies} onUpdate={handleUpdateNode} onDeleteRequest={handleDeleteRequest} onReorder={handleReorderNode} onDragStart={handleDragStart} onDragOver={handleDragOver} onDrop={handleDrop} isDragging={draggedNodeIndex === nodeWithIdx.originalIndex} tripId={tripId} />
                                    ))}
                                </div>
                            ))
                        )}
                    </div>
                    <div className="fixed bottom-6 left-0 right-0 flex justify-center z-30 pointer-events-none">
                        <div className="pointer-events-auto">
                            {!isAdding ? (
                                <button onClick={() => setIsAdding(true)} className={`${theme.btnPrimary} rounded-full px-6 py-4 shadow-[0_8px_20px_-5px_rgba(0,0,0,0.3)] flex items-center gap-2 border-4 border-white`}><Plus className="w-6 h-6" /> æ–°å¢</button>
                            ) : (
                                <div className="bg-white rounded-2xl shadow-2xl p-4 border border-slate-100 w-[90vw] max-w-sm animate-in slide-in-from-bottom-5">
                                    <div className="flex justify-between items-center mb-4"><span className="font-bold text-slate-500 ml-2">é¸æ“‡é¡å‹</span><button onClick={() => setIsAdding(false)} className="p-1 hover:bg-slate-100 rounded-full"><X className="w-5 h-5"/></button></div>
                                    <div className="grid grid-cols-4 gap-2">
                                        {[ { id: 'flight', label: 'èˆªç­', icon: <Plane className="w-5 h-5"/>, color: 'bg-sky-50 text-sky-600' }, { id: 'rental', label: 'ç§Ÿè»Š', icon: <Car className="w-5 h-5"/>, color: 'bg-orange-50 text-orange-600' }, { id: 'hotel', label: 'ä½å®¿', icon: <Home className="w-5 h-5"/>, color: 'bg-amber-50 text-amber-600' }, { id: 'note', label: 'è¡Œç¨‹', icon: <MapPin className="w-5 h-5"/>, color: 'bg-rose-50 text-rose-600' } ].map(type => ( <button key={type.id} onClick={() => handleAddNode(type.id)} className={`flex flex-col items-center p-3 rounded-xl gap-2 hover:scale-95 transition-transform ${type.color}`}>{type.icon}<span className="text-xs font-bold">{type.label}</span></button> ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    {deleteConfirmIndex !== null && ( <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm p-4"> <div className="bg-white p-6 rounded-2xl shadow-2xl max-w-xs w-full animate-in zoom-in-95"> <h3 className="text-lg font-bold text-slate-800 mb-2">ç¢ºå®šåˆªé™¤å—ï¼Ÿ</h3> <div className="flex gap-3 mt-6"> <button onClick={() => setDeleteConfirmIndex(null)} className="flex-1 py-3 font-bold text-slate-500 bg-slate-100 rounded-xl">å–æ¶ˆ</button> <button onClick={confirmDelete} className="flex-1 py-3 font-bold text-white bg-rose-500 rounded-xl shadow-lg">åˆªé™¤</button> </div> </div> </div> )}
                    {showSettings && <SettingsModal currencies={tripData.currencies} onUpdateCurrencies={(c) => saveTrip({ currencies: c })} onClose={() => setShowSettings(false)} />}
                    {showOverview && <TripOverviewModal tripData={tripData} stats={memberStats} onClose={() => setShowOverview(false)} />}
                    {selectedMemberStats && <MemberRPGModal member={selectedMemberStats.member} stats={selectedMemberStats.stats} tripId={tripId} onClose={() => setSelectedMemberStats(null)} />}
                    {showMemberModal && ( <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/20 backdrop-blur-sm sm:p-4"> <div className="bg-white w-full sm:max-w-sm sm:rounded-2xl rounded-t-2xl shadow-2xl h-[40vh] flex flex-col animate-in slide-in-from-bottom-10"> <div className="p-4 border-b border-slate-100 flex justify-between items-center"> <h3 className="font-bold text-lg">æ—…ä¼´æˆå“¡</h3> <button onClick={() => setShowMemberModal(false)} className="p-2 bg-slate-50 rounded-full"><X className="w-5 h-5"/></button> </div> <div className="p-4 flex-1 overflow-y-auto"> <div className="flex gap-2 mb-6"> <input value={newMemberName} onChange={(e) => setNewMemberName(e.target.value)} placeholder="è¼¸å…¥åå­—..." className={`${theme.input} flex-1`} /> <button onClick={handleAddMember} className="bg-slate-800 text-white px-4 rounded-lg font-bold text-sm">æ–°å¢</button> </div> </div> </div> </div> )}
                    {isAdding && <div className="fixed inset-0 bg-black/10 z-20 backdrop-blur-[1px]" onClick={() => setIsAdding(false)}></div>}
                </div>
            );
        };

        const TripListScreen = ({ userId, onSelectTrip }) => {
            const [trips, setTrips] = useState([]);
            const [joinId, setJoinId] = useState('');
            const [isCreating, setIsCreating] = useState(false);
            const [newTripName, setNewTripName] = useState('');

            useEffect(() => {
                if (!userId) return;
                const savedTripIds = JSON.parse(localStorage.getItem(`my_trips_${userId}`) || '[]');
                const fetchTrips = async () => {
                    const loadedTrips = [];
                    for (const id of savedTripIds) {
                        try {
                            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'trips', id);
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists()) loadedTrips.push({ id, ...docSnap.data() });
                        } catch (e) { console.error(e); }
                    }
                    setTrips(loadedTrips);
                };
                fetchTrips();
            }, [userId]);

            const handleCreateTrip = async () => {
                if (!newTripName.trim()) return;
                try {
                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'trips'), {
                        name: newTripName,
                        createdBy: userId,
                        createdAt: serverTimestamp(),
                        nodes: [],
                        members: []
                    });
                    const current = JSON.parse(localStorage.getItem(`my_trips_${userId}`) || '[]');
                    localStorage.setItem(`my_trips_${userId}`, JSON.stringify([docRef.id, ...current]));
                    onSelectTrip(docRef.id);
                } catch (error) { alert("Error"); }
            };

            const handleJoinTrip = async () => {
                if (!joinId.trim()) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'trips', joinId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const current = JSON.parse(localStorage.getItem(`my_trips_${userId}`) || '[]');
                    if (!current.includes(joinId)) localStorage.setItem(`my_trips_${userId}`, JSON.stringify([joinId, ...current]));
                    onSelectTrip(joinId);
                } else { alert("æŸ¥ç„¡è¡Œç¨‹"); }
            };

            return (
                <div className={`p-6 ${theme.bg} min-h-screen`}>
                    <h2 className="text-2xl font-bold text-slate-800 mb-8 flex items-center gap-2"><span className="w-2 h-8 bg-slate-800 rounded-full"></span>æˆ‘çš„æ—…ç¨‹</h2>
                    <div className={`${theme.card} p-5 mb-6 bg-white`}>
                        <label className="text-xs font-bold text-slate-400 mb-2 block uppercase">è¼¸å…¥ ID åŠ å…¥è¡Œç¨‹</label>
                        <div className="flex gap-2">
                            <input type="text" className="flex-1 bg-slate-50 border border-slate-200 px-3 py-2 rounded-lg outline-none text-sm" value={joinId} onChange={(e) => setJoinId(e.target.value)} placeholder="ä¾‹å¦‚: 8s9df8..." />
                            <button onClick={handleJoinTrip} className="bg-slate-800 text-white px-4 py-2 rounded-lg font-bold text-sm">åŠ å…¥</button>
                        </div>
                    </div>
                    {!isCreating ? (
                        <button onClick={() => setIsCreating(true)} className="w-full py-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-bold flex items-center justify-center hover:bg-white transition-all mb-8 gap-2"><Plus className="w-5 h-5" /> è¦åŠƒæ–°æ—…ç¨‹</button>
                    ) : (
                        <div className={`${theme.card} p-5 mb-8 animate-in zoom-in-95`}>
                            <h3 className="font-bold text-slate-800 mb-3 text-sm">æ—…ç¨‹åç¨±</h3>
                            <input type="text" placeholder="ä¾‹å¦‚ï¼š2025 æ±äº¬æš´é£Ÿåœ˜" className={`${theme.input} w-full mb-3`} value={newTripName} onChange={(e) => setNewTripName(e.target.value)} />
                            <div className="flex gap-2 justify-end">
                                <button onClick={() => setIsCreating(false)} className="px-4 py-2 text-slate-500 font-bold text-sm">å–æ¶ˆ</button>
                                <button onClick={handleCreateTrip} className="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold shadow-md text-sm">å»ºç«‹</button>
                            </div>
                        </div>
                    )}
                    <div className="space-y-4">
                        {trips.map(trip => (
                            <div key={trip.id} onClick={() => onSelectTrip(trip.id)} className={`${theme.card} p-5 active:scale-95 transition-all cursor-pointer relative overflow-hidden group hover:shadow-md`}>
                                <div className="flex justify-between items-center">
                                    <div><h4 className="font-bold text-lg text-slate-800">{trip.name}</h4><p className="text-[10px] text-slate-400 mt-1 font-mono tracking-wide">ID: {trip.id.slice(0, 6)}</p></div>
                                    <div className="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center group-hover:bg-slate-800 group-hover:text-white transition-colors"><ArrowLeft className="w-4 h-4 rotate-180" /></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const WelcomeScreen = ({ onStart, loading }) => (
            <div className={`flex flex-col items-center justify-center h-screen ${theme.bg} p-6 text-center relative overflow-hidden`}>
                <div className="absolute top-10 left-10 w-32 h-32 bg-yellow-100 rounded-full opacity-30 blur-3xl"></div>
                <div className="absolute bottom-20 right-10 w-40 h-40 bg-blue-100 rounded-full opacity-30 blur-3xl"></div>
                <div className="z-10 border-4 border-slate-800 p-8 rounded-[2rem] bg-white mb-8 shadow-[8px_8px_0px_0px_rgba(30,41,59,0.1)] transform -rotate-2">
                    <Tent className="w-16 h-16 text-slate-800" />
                </div>
                <h1 className="text-4xl font-black text-slate-800 mb-2 tracking-widest">æ—…äºº_show</h1>
                <p className="text-slate-500 mb-12 text-sm tracking-widest font-medium uppercase">Collaborative Trip Planner</p>
                {loading ? <div className="animate-pulse text-slate-600 font-bold">è¼‰å…¥è³‡æ–™åº«...</div> : (
                    <button onClick={onStart} className="bg-slate-800 text-[#fdfbf7] px-12 py-4 rounded-2xl font-bold text-lg shadow-xl active:scale-95 transition-all border-2 border-slate-800 hover:shadow-2xl">é–‹å§‹è¦åŠƒ</button>
                )}
            </div>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('welcome'); 
            const [currentTripId, setCurrentTripId] = useState(null);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                const initAuth = async () => {
                    setLoading(true);
                    try {
                        if (typeof initialAuthToken !== 'undefined' && initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch(e) { console.error("Auth error", e); }
                    setLoading(false);
                };
                initAuth();
                onAuthStateChanged(auth, setUser);
            }, []);

            const handleStart = () => {
                if (user) {
                    setView('list');
                } else {
                    alert("å°šæœªé€£ç·šåˆ°è³‡æ–™åº«ã€‚è«‹ç¢ºèªæ˜¯å¦å·²å¡«å…¥æ­£ç¢ºçš„ Firebase API Keyã€‚");
                }
            };

            const handleSelectTrip = (id) => { setCurrentTripId(id); setView('detail'); };
            const handleBackToList = () => { setCurrentTripId(null); setView('list'); };

            return (
                <div className="font-sans antialiased text-slate-900 max-w-md mx-auto bg-[#fdfbf7] min-h-screen shadow-2xl overflow-hidden relative">
                    {view === 'welcome' && <WelcomeScreen onStart={handleStart} loading={loading} />}
                    {view === 'list' && <TripListScreen userId={user?.uid} onSelectTrip={handleSelectTrip} />}
                    {view === 'detail' && <TripDetailScreen userId={user?.uid} tripId={currentTripId} onBack={handleBackToList} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>